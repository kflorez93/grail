#!/usr/bin/env bash
set -euo pipefail

# Sessions
if command -v tmux >/dev/null 2>&1 && tmux list-sessions >/dev/null 2>&1; then
  sessions=$(tmux list-sessions -F '#S' | awk '{print "\""$0"\""}' | paste -sd, -)
  sessions_json="[${sessions}]"
else
  sessions_json="[]"
fi

# Watchers from registry
CACHE_DIR="${DOCUDEX_CACHE_DIR:-.docudex-cache}"
REG_DIR="$CACHE_DIR/watchers"
if [[ -d "$REG_DIR" ]]; then
  watchers_json=$(ls -1 "$REG_DIR" 2>/dev/null | sed 's#^#'"$REG_DIR"'/#' | xargs -I{} sh -c 'cat "{}"' 2>/dev/null | paste -sd, - | sed 's/^/[/' | sed 's/$/]/')
  if [[ -z "$watchers_json" || "$watchers_json" = "[]" ]]; then watchers_json="[]"; fi
else
  watchers_json="[]"
fi

# Git diff stat
if command -v git >/dev/null 2>&1; then
  diff_stat=$(git diff --stat || true)
else
  diff_stat=""
fi

printf '{"sessions":%s,"watchers":%s,"git_diff_stat":%s}\n' "$sessions_json" "$watchers_json" "$(printf "%s" "$diff_stat" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))' 2>/dev/null || node -e 'let d="";process.stdin.on("data",c=>d+=c).on("end",()=>console.log(JSON.stringify(d)))')"
