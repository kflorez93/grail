#!/usr/bin/env bash
set -euo pipefail

# Sessions
if command -v tmux >/dev/null 2>&1 && tmux list-sessions >/dev/null 2>&1; then
  # Build JSON with name and pid
  out='['
  first=1
  while IFS= read -r s; do
    name="$s"
    pid=$(tmux display-message -p -t "$name" '#{pane_pid}' 2>/dev/null | head -n1)
    entry=$(printf '{"name":"%s","pid":%s}' "$name" "${pid:-0}")
    if [[ $first -eq 1 ]]; then out+="$entry"; first=0; else out+=",$entry"; fi
  done < <(tmux list-sessions -F '#S' 2>/dev/null)
  out+=']'
  sessions_json="$out"
else
  sessions_json="[]"
fi

# Watchers from registry
CACHE_DIR="${DOCUDEX_CACHE_DIR:-.docudex-cache}"
REG_DIR="$CACHE_DIR/watchers"
if [[ -d "$REG_DIR" ]]; then
  watchers_json=$(ls -1 "$REG_DIR" 2>/dev/null | sed 's#^#'"$REG_DIR"'/#' | xargs -I{} sh -c 'cat "{}"' 2>/dev/null | paste -sd, - | sed 's/^/[/' | sed 's/$/]/')
  if [[ -z "$watchers_json" || "$watchers_json" = "[]" ]]; then watchers_json="[]"; fi
else
  watchers_json="[]"
fi

# Git diff stat
if command -v git >/dev/null 2>&1; then
  diff_stat=$(git diff --stat || true)
else
  diff_stat=""
fi

printf '{"sessions":%s,"watchers":%s,"git_diff_stat":%s}\n' "$sessions_json" "$watchers_json" "$(printf "%s" "$diff_stat" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))' 2>/dev/null || node -e 'let d="";process.stdin.on("data",c=>d+=c).on("end",()=>console.log(JSON.stringify(d)))')"
